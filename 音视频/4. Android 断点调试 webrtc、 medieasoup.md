

[TOC]


>本文首发地址 <https://h89.cn/archives/248.html>  
>最新更新地址 <https://gitee.com/chenjim/chenjimblog>  
>本文适用于 [mediasoup-demo-android](https://github.com/haiyangwu/mediasoup-demo-android) 和 [mediasoup-client-android](https://github.com/haiyangwu/mediasoup-client-android) ，也适用于 webrtc [AppRTCDemo](https://github.com/mthli/YaaRTC) 

## 调试代码工程准备  

### mediasoup 代码准备 
- 将 `mediasoup-demo-android`  `mediasoup-client-android` git clone 到一个目录
- 修改 `app/build.gradle`, 去掉 `implementation fileTree(dir: 'libs', include: ['*.jar'])`
  将 `implementation 'org.mediasoup.droid:mediasoup-client:3.0.8-beta-3'` 改为  
  ```
    if (client_project_build.toBoolean()) {
        implementation project(':media_client')
    } else {
        implementation 'org.mediasoup.droid:mediasoup-client:3.0.8-beta-3'
    }
  ```
- `gradle.properties` 中添加 `client_project_build=true`  
  控制使用源码编译，还是直接用编译好的 aar
- `settings.gradle` 修改结果如下   
  ``` Groovy 
  include ':app'
  if (client_project_build.toBoolean()) {
      include ':media_client'
      project(":media_client").projectDir = new File(rootDir, "../mediasoup-client-android/mediasoup-client")
  }
  ```  

### webrtc代码准备 
本文安卓使用的代码是 [mthli/YaaRTC](https://github.com/mthli/YaaRTC)   
需要参考后文编译好需要的 aar 后， 替换其中的 `app/libs/libwebrtc.aar`  
配合服务端 <https://appr.tc/> 调试  



## 编译 Debug 包  
修改 `./build/toolchain/android/BUILD.gn`如下，编译Release时需要恢复    

  ``` python
  template("android_clang_toolchain") {
    ...
    _prefix = rebase_path("$clang_base_path/bin", root_build_dir)
    cc = "$_prefix/clang"
    cxx = "$_prefix/clang++"
    ar = "$_prefix/llvm-ar"
    ld = cxx
    readelf = _tool_prefix + "readelf"
    nm = _tool_prefix + "nm"
    # 注释掉下面三行配置，即可实现 unstrip
    # strip = rebase_path("//buildtools/third_party/eu-strip/bin/eu-strip",
    #                     root_build_dir)
    # use_unstripped_as_runtime_outputs = android_unstripped_runtime_outputs
    ...
  }
  ```

----


## 添加编译参数 

关键参数为 `is_debug=true symbol_level=2 android_full_debug=true`  
``` bash
$ ./tools_webrtc/android/build_aar.py \
  --extra-gn-args "is_debug=true symbol_level=2 android_full_debug=true" \
  --arch arm64-v8a
```
我们可以用 Linux 命令 `cp` 将编译结果复制到我们需要用的地方  

-----


## 安卓应用中修改 `app/build.gradle`
如下    
  ``` gradle 
  ...
  android {
    buildTypes {
      debug {
        debuggable true     // 必须设置为 true
        jniDebuggable true  // 必须设置为 true
        minifyEnabled false // 必须设置为 false
      }
    }
    packagingOptions {
      ...
      // 如果不设置 doNotStrip，编译出来的安装包还是会丢失调试信息；
      // 因为我们只编译了 arm64-v8a 架构的包，所以只需要配置这一行即可
      doNotStrip "*/arm64-v8a/*.so"
    }
  }
  ...
  ```

----

## 设置DEBUG TYPE  
![](https://pic.chenjim.com/20210830130406.png-blog)   
![](https://pic.chenjim.com/20210830130846.png-blog)   

----

## 设置源码映射  
  ```bash
  # https://stackoverflow.com/a/53065726/4696820
  # 查看 Native 层 webrtc::PeerConnection::RestartIce 这个方法的调试信息；
  # 这里选用 RestartIce 而不是 CreateOffer 作为示例的原因是其输出单一，易于阅读
  (lldb) image lookup -vrn webrtc::PeerConnection::RestartIce
  # 设置源码映射，注意替换为自己的路径
  (lldb) settings set target.source-map ../../../ D:\code\mediasoup-client-android\mediasoup-client\deps\webrtc\src
  ```
  如下图，要先点左边的'暂停'，右边才能通过命令 `image lookup -vrn webrtc::PeerConnection::RestartIce` 设置一个断点     
  ![](https://pic.chenjim.com/20210830131034.png-blog)



## 可能遇到的问题  

- 部分文件无法在AS跟踪的问题  
.gitignore 忽略的，可以临时去掉其中部分内容  
不在工程目录的文件也无法跟踪，可以复制相关的代码过来  
然后AS菜单-->File -->`Invalidata Caches Restart`     

---

## webrtc 安卓开发环境  

-  我开发环境是在 windows + VirtualBox + Ubuntu 2004 虚拟机  
如上 `webrtc\src` 的代码需要跟虚拟机 `webrtc\src` 代码同步   
我的方法是：Ubuntu 通过 smb 共享 webrtc 代码， `windows` 下用 `BeyondCompare` 比较同步    
- 如果全部在 Ubuntu ，使用 `ln` 创建软链接，可能会更方便一些，未验证     
- 把代码放 windows , 在 `WindowSubLinux` 下的 `Ubuntu` 编译   
  当然也是可以的，注意需要解决 `snap` 问题，参考 [webrtc编译](https://h89.cn/archives/235.html)   


-----

本文参考自  <https://webrtc.mthli.com/basic/webrtc-breakpoint/>  
该文中还有一些比较好 `webrtc相关知识` 文档  
比如 [SDP 会话描述介绍](https://webrtc.mthli.com/basic/sdp-introduction/) 、[ RTP 协议介绍 ](https://webrtc.mthli.com/lost/rtp-introduction/)、[视频旋转角度](https://webrtc.mthli.com/lost/rtp-introduction/#%E8%8E%B7%E5%8F%96%E8%A7%86%E9%A2%91%E6%97%8B%E8%BD%AC%E8%A7%92%E5%BA%A6) 等

----

其它相关文档  

- [安卓webrtc在ubuntu 2004下编译使用](https://h89.cn/archives/235.html)

- [Android 断点调试 webrtc、 medieasoup](https://h89.cn/archives/248.html)  

- [安卓增加 mediasoup webrtc 日志输出](https://h89.cn/archives/246.html)  

- [安卓 Mediasoup V3 基于webrtc 分支m84 的编译](https://h89.cn/archives/245.html)

- [安卓 webrtc 开启h264 软编解码](https://h89.cn/archives/6.html)  

- [安卓mediasoup输出H264流(支持H264编码)](https://h89.cn/archives/1.html)  

- [安卓mediasoup webrtc h264 软编解码相关源码分析](https://h89.cn/archives/250.html)   



